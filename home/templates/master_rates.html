{% extends "master.html" %}

{% block title %}
Master Rates Schedule
{% endblock %}

{% block content %}
<h1>Master Rates Schedule</h1>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Material</th>
                <th>Units</th>
                <th>Rate</th>
                <th>Supplier</th>
                <th>Actions</th> <!-- Added Actions header -->
            </tr>
        </thead>
        <tbody>
            {% for x in materials_list %}
            <tr data-id="{{ x.id }}">
                <td>{{x.material}}</td>
                <td>{{x.units}}</td>
                <td>{{x.rate}}</td>
                <td>{{x.supplier}}</td>
                <td>
                    <button class="small-btn" onclick="editRow(this)">Edit</button>
                    <button class="small-btn" onclick="deleteRow(this)">Delete</button> <!-- Added Edit and Delete buttons -->
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="table-container">
        <!-- Add Button -->
        <button class="small-btn" id="addRateBtn">Add New Line</button>
    
        <!-- ... existing table structure ... -->
    </div>
</div>

<script>

function saveNewMaterialRate(row) {
    var supplierSelect = row.cells[3].getElementsByTagName('select')[0];
    var supplierId = supplierSelect.value; // Get selected supplier ID

    var materialData = {
        'material': row.cells[0].getElementsByTagName('input')[0].value,
        'units': row.cells[1].getElementsByTagName('input')[0].value,
        'rate': row.cells[2].getElementsByTagName('input')[0].value,
        'supplier': supplierId, // Using the supplier ID
        'csrfmiddlewaretoken': '{{ csrf_token }}'
    };

    fetch('/save_material_rate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': materialData.csrfmiddlewaretoken
        },
        body: JSON.stringify(materialData)
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success') {
            alert('Material rate saved successfully');
            location.reload();  // Reload the page
        } else {
            alert('Error saving material rate: ' + data.message);
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('An error occurred while saving the material rate.');
    });
}


    function editRow(button) {
    var row = button.parentNode.parentNode;
    var cells = row.getElementsByTagName('td');

    for (var i = 0; i < cells.length - 1; i++) {
        var value = cells[i].innerText;
        cells[i].innerText = '';
        if (i === 3) { // Assuming supplier is the 4th column
            var select = document.createElement('select');
            {% for supplier in suppliers_list %}
            var option = document.createElement('option');
            option.value = "{{ supplier.id }}";
            option.text = "{{ supplier.supplier }}";
            select.appendChild(option);
            if (value === "{{ supplier.supplier }}") {
                option.selected = true;
            }
            {% endfor %}
            cells[i].appendChild(select);
        } else {
            var input = document.createElement('input');
            input.type = 'text';
            input.value = value;
            cells[i].appendChild(input);
        }
    }

    // Change the Edit button to a Save button
    button.innerText = 'Save';
    button.onclick = function() { saveEditedRow(row); };
}


    function deleteRow(button) {
    if (confirm('Are you sure you want to delete this row?')) {
        var row = button.parentNode.parentNode;
        var materialId = row.getAttribute('data-id'); // Get the ID of the material

        fetch('/delete_material_rate/', { // Replace with your actual delete URL
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 'id': materialId })
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                alert('Material rate deleted successfully');
                row.remove(); // Remove the row from the table
            } else {
                alert('Error deleting material rate: ' + data.message);
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('An error occurred while deleting the material rate.');
        });
    }
}


function saveEditedRow(row) {
    var materialId = row.getAttribute('data-id');
    var cells = row.getElementsByTagName('td');
    var supplierSelect = cells[3].getElementsByTagName('select')[0];
    var supplierName = supplierSelect.options[supplierSelect.selectedIndex].text; // Fetch the text of the selected option

    var materialData = {
        'id': materialId,
        'material': cells[0].getElementsByTagName('input')[0].value,
        'units': cells[1].getElementsByTagName('input')[0].value,
        'rate': cells[2].getElementsByTagName('input')[0].value,
        'supplier': supplierName, // Using the supplier name
        'csrfmiddlewaretoken': '{{ csrf_token }}'
    };

    // AJAX request to update the material rate
    fetch('/update_material_rate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': materialData.csrfmiddlewaretoken
        },
        body: JSON.stringify(materialData)
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success') {
            alert('Material rate updated successfully');
            location.reload(); // Or dynamically update the row in the table
        } else {
            alert('Error updating material rate: ' + data.message);
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('An error occurred while updating the material rate.');
    });
}


  
document.getElementById('addRateBtn').addEventListener('click', function() {
    var table = document.querySelector('.table-container table tbody');
    var newRow = table.insertRow(-1); // Insert a row at the end of the table

    // Fields except supplier
    var fields = ['material', 'units', 'rate'];
    fields.forEach(function(field, index) {
        var cell = newRow.insertCell(index);
        var input = document.createElement('input');
        input.type = 'text';
        input.name = field;
        cell.appendChild(input);
    });

    // Add supplier dropdown in a separate cell
    var supplierCell = newRow.insertCell(fields.length);
    var select = document.createElement('select');
    var defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.text = '-- Select a Supplier --';
    select.appendChild(defaultOption);

    // Populate with suppliers
    {% for supplier in suppliers_list %}
    var option = document.createElement('option');
    option.value = "{{ supplier.id }}";
    option.text = "{{ supplier.supplier }}";
    select.appendChild(option);
    {% endfor %}

    supplierCell.appendChild(select);

    // Add save button in the next cell
    var saveCell = newRow.insertCell(fields.length + 1);
    var saveBtn = document.createElement('button');
    saveBtn.innerHTML = 'Save';
    saveBtn.addEventListener('click', function() { saveNewMaterialRate(newRow); });
    saveCell.appendChild(saveBtn);
});


  
</script>

{% endblock %}
